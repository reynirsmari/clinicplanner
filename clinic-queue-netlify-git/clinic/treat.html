<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Treat patient</title>
<style>
:root{--bg:#f7f8fb;--card:#fff;--line:#e5e7eb;--muted:#6b7280;--text:#0f172a;--blue:#2563eb;--green:#16a34a;--red:#dc2626}
*{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
body{margin:0;background:var(--bg);color:var(--text)}
.wrap{max-width:1100px;margin:24px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 4px 10px rgba(15,23,42,.04);padding:16px 16px 20px;margin-bottom:12px}
h1{margin:0 0 12px;font-size:28px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:800px){.grid{grid-template-columns:1fr}}
.label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px}
.box{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;min-height:44px}
.badges{display:flex;flex-wrap:wrap;gap:8px}
.badge{background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:6px 10px;border-radius:999px;font-size:12px}
.btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer}
.btn.blue{background:#2563eb;border-color:#2563eb;color:#fff}
.btn.red{color:#dc2626;border-color:#fecaca}
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Treat patient</h1>

  <div class="grid">
    <div class="card">
      <div class="label">Name</div>
      <div id="name" class="box">—</div>
    </div>
    <div class="card">
      <div class="label">Kennitala</div>
      <div id="kt" class="box">—</div>
    </div>
    <div class="card">
      <div class="label">Phone</div>
      <div id="phone" class="box">—</div>
    </div>
    <div class="card">
      <div class="label">Primary complaint</div>
      <div id="complaint" class="box">—</div>
    </div>
    <div class="card" style="grid-column:1 / -1">
      <div class="label">Complaint details</div>
      <div id="details" class="box badges">—</div>
    </div>
    <div class="card" style="grid-column:1 / -1">
      <div class="label">Patient notes</div>
      <div id="pnotes" class="box">—</div>
    </div>
    <div class="card" style="grid-column:1 / -1">
      <div class="label">Doctor notes</div>
      <textarea id="dnotes" class="box" style="height:160px"></textarea>
    </div>
  </div>

  <div class="actions">
    <button class="btn blue" id="call">Call patient</button>
    <button class="btn" id="return">Return patient to queue</button>
    <button class="btn" id="export">Export patient to Saga</button>
    <button class="btn red" id="treated">Patient treated</button>
  </div>
</div>

<script>
const id = new URL(location.href).searchParams.get('id');
const treatingKey = 'clinic:treating';
const channelName = 'clinic-queue-sync';

function getTreating(){ try{return new Set(JSON.parse(localStorage.getItem(treatingKey)||'[]'));}catch{return new Set();} }
function setTreating(set){ localStorage.setItem(treatingKey, JSON.stringify([...set])); }

async function load(){
  const r = await fetch('/api/tickets-get?id='+encodeURIComponent(id));
  const j = await r.json();
  if(!j.ok || !j.ticket){ document.body.innerHTML = '<div class="wrap"><div class="card">Ticket not found.</div></div>'; return; }
  const t = j.ticket;
  document.getElementById('name').textContent = t.name || '—';
  document.getElementById('kt').textContent = t.kt || '—';
  document.getElementById('phone').textContent = t.phone || '—';
  document.getElementById('complaint').textContent = t.complaint || '—';
  const arr = (t.details && Array.isArray(t.details) && t.details.length ? t.details : (t.subcomplaints||[]));
  const detailsEl = document.getElementById('details');
  if(arr && arr.length){
    detailsEl.innerHTML = arr.map(s=>'<span class="badge">'+escapeHtml(s)+'</span>').join('');
  }else{
    detailsEl.textContent = '—';
  }
  document.getElementById('pnotes').textContent = t.notes || '—';
}
function escapeHtml(s){return (s??'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}
load();

document.getElementById('call').onclick = async ()=>{
  const r = await fetch('/api/tickets-notify?id='+encodeURIComponent(id), {method:'POST'});
  const j = await r.json().catch(()=>({ok:false}));
  if(!j.ok) return alert('Failed to notify');
  alert('Patient notified.');
};

document.getElementById('return').onclick = ()=>{
  const s = getTreating(); s.delete(id); setTreating(s);
  try{ new BroadcastChannel(channelName).postMessage({type:'treating-updated', id}); }catch{}
  alert('Returned to queue.');
};

document.getElementById('export').onclick = ()=>{ alert('Patient data has been exported to Saga.'); };

document.getElementById('treated').onclick = async ()=>{
  if(!confirm('Mark patient as treated and remove from queue?')) return;
  const r = await fetch('/api/tickets-delete?id='+encodeURIComponent(id), {method:'POST'});
  const j = await r.json().catch(()=>({ok:false}));
  if(!j.ok) return alert('Failed to remove');
  const s = getTreating(); s.delete(id); setTreating(s);
  try{ new BroadcastChannel(channelName).postMessage({type:'treating-updated', id}); }catch{}
  window.close();
};
</script>
</body>
</html>
