<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Treat patient</title>
  <style>
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px}
    .label{font-size:.85rem;color:#6b7280;margin-bottom:.25rem}
    .value{font-weight:700;font-size:1.1rem}
  </style>
</head>
<body>
  <main style="max-width:1100px;margin:0 auto;padding:16px">
    <h1 style="font-size:1.6rem;margin:6px 0 14px">Treat patient</h1>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div class="card"><div class="label">NAME</div><div id="p-name" class="value">—</div></div>
      <div class="card"><div class="label">KENNITALA</div><div id="p-kt" class="value">—</div></div>
      <div class="card"><div class="label">PHONE</div><div id="p-phone" class="value">—</div></div>
      <div class="card"><div class="label">PRIMARY COMPLAINT</div><div id="p-complaint" class="value">—</div></div>
      <div class="card" style="grid-column:1 / span 2">
        <div class="label">COMPLAINT DETAILS</div>
        <div id="p-details" class="value" style="font-weight:500">—</div>
      </div>
      <div class="card" style="grid-column:1 / span 2">
        <div class="label">PATIENT NOTES</div>
        <div id="p-notes" class="value" style="font-weight:500">—</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="label">DOCTOR NOTES</div>
      <textarea id="doc-notes" rows="6" style="width:100%"
        placeholder="Add clinical notes here... (local to this browser)"></textarea>
    </div>

    <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap">
      <button id="btn-call">Call patient</button>
      <button id="btn-return">Return patient to queue</button>
      <button id="btn-export">Export patient to Saga</button>
      <button id="btn-treated" style="background:#fee2e2">Patient treated</button>
    </div>
  </main>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    async function load(){
      const res = await fetch(`/api/tickets-get?id=${encodeURIComponent(id)}`);
      const data = await res.json();
      if(!data.ok){ alert('Ticket not found'); return; }
      const t = data.ticket;
      document.getElementById('p-name').textContent = t.name || '—';
      document.getElementById('p-kt').textContent = t.kt || '—';
      document.getElementById('p-phone').textContent = t.phone || '—';
      document.getElementById('p-complaint').textContent = t.complaint || '—';

      const details = (Array.isArray(t.subComplaints) && t.subComplaints.length)
        ? t.subComplaints.join(', ')
        : (t.details || '—');
      document.getElementById('p-details').textContent = details;

      document.getElementById('p-notes').textContent = t.notes || '—';
    }
    load();

    document.getElementById('btn-call').addEventListener('click', async ()=>{
      await fetch(`/api/tickets-notify?id=${encodeURIComponent(id)}`, { method:'POST' });
      alert('Patient notified');
    });
    document.getElementById('btn-return').addEventListener('click', async ()=>{
      await fetch(`/api/tickets-status?id=${encodeURIComponent(id)}&status=waiting`, { method:'POST' });
      alert('Returned to queue');
    });
    document.getElementById('btn-treated').addEventListener('click', async ()=>{
      await fetch(`/api/tickets-delete?id=${encodeURIComponent(id)}`, { method:'POST' });
      window.close();
    });
    document.getElementById('btn-export').addEventListener('click', ()=>{
      alert('Patient data has been exported to the Saga system.');
    });
  </script>
</body>
</html>
