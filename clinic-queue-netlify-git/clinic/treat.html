<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Treat patient</title>
  <style>
    :root { --border:#e6e9ee; --muted:#6b7280; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#f7f8fb; margin:0; }
    .wrap { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:20px; }
    h1 { margin: 0 0 16px; font-weight:700; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    .field { display:flex; flex-direction:column; gap:8px; }
    .label { font-size:13px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted) }
    .view { padding:12px 14px; border:1px solid var(--border); border-radius:10px; background:#fff; min-height:22px; }
    textarea { min-height:160px; border:1px solid var(--border); border-radius:10px; padding:12px 14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-top:16px; }
    .btn { padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .btn.primary { background:#0b5fff; color:#fff; border:0; }
    .btn.danger { background:#fee2e2; color:#991b1b; border-color:#fecaca; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Treat patient</h1>

      <div class="grid">
        <div class="field">
          <div class="label">Name</div>
          <div id="pName" class="view">—</div>
        </div>
        <div class="field">
          <div class="label">Kennitala</div>
          <div id="pKt" class="view">—</div>
        </div>
        <div class="field">
          <div class="label">Phone</div>
          <div id="pPhone" class="view">—</div>
        </div>
        <div class="field">
          <div class="label">Primary complaint</div>
          <div id="pComplaint" class="view">—</div>
        </div>
        <div class="field" style="grid-column:1 / -1">
          <div class="label">Complaint details</div>
          <div id="pDetails" class="view">—</div>
        </div>
        <div class="field" style="grid-column:1 / -1">
          <div class="label">Patient notes</div>
          <div id="pNotes" class="view">—</div>
        </div>
        <div class="field" style="grid-column:1 / -1">
          <div class="label">Doctor notes</div>
          <textarea id="docNotes" placeholder="Add clinical notes here… (local to this browser)"></textarea>
        </div>
      </div>

      <div class="row">
        <button id="btnCall" class="btn primary">Call patient</button>
        <button id="btnReturn" class="btn">Return patient to queue</button>
        <button id="btnExport" class="btn">Export patient to Saga</button>
        <button id="btnTreated" class="btn danger">Patient treated</button>
      </div>
    </div>
  </div>

  <script>
    const params = new URL(location.href).searchParams;
    const id = params.get("id");

    async function load() {
      try {
        const res = await fetch("/api/tickets-get?id=" + encodeURIComponent(id));
        const js = await res.json();
        if (!js || !js.ok) throw new Error("Not found");
        const t = js.ticket;

        document.getElementById("pName").textContent = t.name || "—";
        document.getElementById("pKt").textContent = t.kt || "—";
        document.getElementById("pPhone").textContent = t.phone || "—";
        document.getElementById("pComplaint").textContent = t.complaint || "—";
        const details = (Array.isArray(t.subComplaints) && t.subComplaints.length) ? t.subComplaints.join(", ") : "—";
        document.getElementById("pDetails").textContent = details;
        document.getElementById("pNotes").textContent = t.notes || "—";
      } catch (e) {
        alert("Could not load ticket");
      }
    }

    async function callPatient() {
      await fetch("/api/tickets-notify?id=" + encodeURIComponent(id), { method: "POST" });
    }
    async function returnToQueue() {
      await fetch("/api/tickets-unassign?id=" + encodeURIComponent(id), { method: "POST" }).catch(()=>{});
      window.close();
    }
    async function markTreated() {
      await fetch("/api/tickets-delete?id=" + encodeURIComponent(id), { method: "POST" }).catch(()=>{});
      window.close();
    }
    function exportSaga() {
      alert("Patient data has been exported to the Saga system.");
    }

    document.getElementById("btnCall").onclick = callPatient;
    document.getElementById("btnReturn").onclick = returnToQueue;
    document.getElementById("btnTreated").onclick = markTreated;
    document.getElementById("btnExport").onclick = exportSaga;

    load();
  </script>
</body>
</html>
