<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinic Queue</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#5b6b82;
      --divider:#e5eaf2;
      --green:#22c55e;
      --green-ink:#0f8a3c;
      --blue:#6e8efb;
      --blue-ink:#2643a3;
      --red:#ff6b6b;
      --radius:16px;
      --shadow:0 6px 24px rgba(18, 38, 63, 0.06);
    }
    html,body{background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Text", "Helvetica Neue", Arial; margin:0}
    .wrap{max-width:1100px; margin:32px auto; padding:0 16px}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .hdr{display:flex; align-items:center; justify-content:space-between; padding:20px 24px; border-bottom:1px solid var(--divider)}
    .hdr h1{font-size:20px; margin:0}
    .ts{color:var(--muted); font-size:13px}
    table{width:100%; border-collapse:collapse; border-spacing:0}
    thead th{font-size:14px; letter-spacing:.04em; text-transform:uppercase; color:var(--muted); text-align:left; padding:14px 20px; background:var(--card)}
    tbody td{padding:18px 20px; vertical-align:middle; background:var(--card)}
    /* draw full-width separator for every cell so the line doesn't break under Actions */
    tbody tr:not(:last-child) td{border-bottom:1px solid var(--divider)}
    .num{font-weight:800; font-size:22px}
    .name{font-weight:800; font-size:26px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border-radius:999px; font-weight:700; font-size:16px}
    .pill.green{background:#e8f5ee; color:var(--green-ink); border:1px solid #bbecd0}
    .actions{display:flex; gap:12px; justify-content:flex-end}
    .btn{border:0; border-radius:14px; padding:12px 18px; font-weight:700; font-size:16px; cursor:pointer; transition:.15s transform}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--blue); color:#fff}
    .btn.primary[disabled]{opacity:.55; cursor:default; background:#b9c7ff; color:#fff}
    .btn.danger{background:#ffe8e8; color:#c71d1d; border:1px solid #ffd4d4}
    .idtag{display:inline-block; margin-top:8px; padding:6px 12px; border-radius:999px; background:#eef2ff; color:#3546b6; font-weight:600}
    .complaint{font-size:26px; font-weight:700}
    .muted{color:var(--muted)}
    @media (max-width: 820px){
      thead{display:none}
      table, tbody, tr, td{display:block; width:100%}
      tbody td{border:0 !important; padding:10px 16px}
      tbody tr{border-bottom:1px solid var(--divider)}
      .row{display:grid; grid-template-columns: 48px 1fr; gap:8px; align-items:center}
      .actions{justify-content:flex-start}
      .complaint{font-size:18px}
      .name{font-size:20px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hdr">
        <h1>Queue</h1>
        <div class="ts" id="ts">—</div>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:80px">#</th>
              <th>Patient</th>
              <th>Primary complaint</th>
              <th>Created</th>
              <th>Status</th>
              <th style="width:290px; text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="muted" style="text-align:center; padding:28px">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const fmt = (ts) => {
  try{ return new Intl.DateTimeFormat(undefined,{day:'2-digit',month:'2-digit',year:'numeric', hour:'2-digit', minute:'2-digit'}).format(new Date(ts)); }
  catch{ return ts; }
}

const openKey = 'clinic:open';
let openSet = new Set(JSON.parse(localStorage.getItem(openKey) || '[]'));

function persistOpen(){
  localStorage.setItem(openKey, JSON.stringify([...openSet]));
}

async function fetchList(){
  const r = await fetch('/api/tickets-list');
  const j = await r.json();
  if(!j.ok){ throw new Error(j.error || 'Failed'); }
  return j.items || [];
}

function rowHTML(item, idx){
  const position = item.position ?? (idx+1);
  const notified = !!item.notifiedAt || item.status === 'called';
  return `
    <tr data-id="${item.id}">
      <td class="num">${position}</td>
      <td>
        <div class="name">${escapeHtml(item.name || '—')}</div>
        <div class="idtag">ID: ${escapeHtml(item.id)}</div>
      </td>
      <td><div class="complaint">${escapeHtml(item.complaint || '—')}</div></td>
      <td class="muted">${fmt(item.createdAt)}</td>
      <td>${ item.status === 'called' ? '<span class="pill green">Called</span>' : ''}</td>
      <td>
        <div class="actions">
          <button class="btn primary" ${notified?'disabled':''} onclick="notify('${item.id}')">${notified?'Notified':'Notify'}</button>
          <button class="btn danger" onclick="delTicket('${item.id}')">Delete</button>
        </div>
      </td>
    </tr>
  `;
}

function escapeHtml(s){ return (s ?? '').toString().replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

async function render(){
  try{
    const items = await fetchList();
    document.getElementById('ts').textContent = 'Updated ' + new Date().toLocaleTimeString();
    const tbody = document.getElementById('tbody');
    if(!items.length){
      tbody.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center; padding:28px">No patients in queue.</td></tr>';
      return;
    }
    tbody.innerHTML = items.map(rowHTML).join('');
  }catch(e){
    document.getElementById('tbody').innerHTML = '<tr><td colspan="6" style="color:#b91c1c; padding:28px; text-align:center">Failed to load queue.</td></tr>';
    console.error(e);
  }
}

async function notify(id){
  try{
    const r = await fetch('/api/tickets-notify?id='+encodeURIComponent(id), {method:'POST'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Notify failed');
  }catch(e){ alert('Failed to notify: ' + e.message); }
  await render();
}

async function delTicket(id){
  if(!confirm('Delete this ticket?')) return;
  try{
    const r = await fetch('/api/tickets-delete?id='+encodeURIComponent(id), {method:'POST'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Delete failed');
  }catch(e){ alert('Failed to delete: ' + e.message); }
  await render();
}

render();
setInterval(render, 5000);
</script>
</body>
</html>
