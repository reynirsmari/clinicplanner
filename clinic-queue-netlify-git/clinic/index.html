
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Clinic Queue</title>
  <style>
    :root{
      --bg:#f8fafc; --panel:#ffffff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
      --green:#16a34a; --green-weak:#dcfce7; --blue:#3b82f6; --blue-weak:#dbeafe; --red:#ef4444; --red-weak:#fee2e2;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    h1{font-size:24px;font-weight:700;margin:0 0 16px}
    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;font-size:12px;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);font-weight:700;padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:1;background:#fff;}
    tbody td{padding:16px;border-bottom:1px solid var(--line);vertical-align:middle}
    tbody tr:last-child td{border-bottom-color:transparent}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:.2rem .6rem;border-radius:999px;font-weight:600;font-size:12px}
    .badge.waiting{background:#f1f5f9;color:#334155;border:1px solid var(--line)}
    .badge.called{background:var(--green-weak);color:var(--green);border:1px solid #86efac}
    .btn{border:none;border-radius:10px;padding:.55rem .9rem;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.55;cursor:default}
    .btn.notify{background:var(--blue);color:white}
    .btn.notified{background:var(--blue-weak);color:#1e40af}
    .btn.delete{background:var(--red-weak);color:var(--red)}
    .row{transition:background .15s ease}
    .row:hover{background:#f8fafc}
    .small{font-size:12px;color:var(--muted)}
    .actions{white-space:nowrap}
    .name{font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Queue</h1>
    <div class="card">
      <table aria-label="Queue">
        <thead>
          <tr>
            <th style="width:64px">#</th>
            <th>Patient</th>
            <th>Primary complaint</th>
            <th>Created</th>
            <th>Status</th>
            <th class="actions" style="width:220px">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="small" style="padding:20px" id="loading">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const $tbody = document.getElementById('tbody');

    const api = (p)=> `/api/${p}`;

    const expandedKey = 'clinic.expanded';
    const getExpanded = () => new Set(JSON.parse(localStorage.getItem(expandedKey) || '[]'));
    const setExpanded = (set) => localStorage.setItem(expandedKey, JSON.stringify([...set]));

    let expanded = getExpanded();

    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return new Intl.DateTimeFormat(navigator.language,{ dateStyle:'short', timeStyle:'short'}).format(d);
      }catch(e){ return iso || '' }
    }

    async function notify(id, btn){
      btn.disabled = true;
      try{
        const res = await fetch(api(`tickets-notify?id=${encodeURIComponent(id)}`), {method:'POST'});
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || 'Notify failed');
        btn.classList.remove('notify'); btn.classList.add('notified'); btn.textContent = 'Notified';
      }catch(err){
        alert('Failed to notify: ' + err.message);
        btn.disabled = false;
      }
    }

    async function remove(id){
      if(!confirm('Delete this ticket?')) return;
      try{
        const res = await fetch(api(`tickets-delete?id=${encodeURIComponent(id)}`), {method:'POST'});
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || 'Delete failed');
        await load();
      }catch(err){
        alert('Failed to delete: ' + err.message);
      }
    }

    function render(items){
      $tbody.innerHTML = '';
      if(!Array.isArray(items) || items.length === 0){
        $tbody.innerHTML = '<tr><td colspan="6" class="small" style="padding:20px">No patients in queue.</td></tr>';
        return;
      }

      items.sort((a,b)=> (a.position ?? 9999) - (b.position ?? 9999) || new Date(a.createdAt)-new Date(b.createdAt));

      for(const t of items){
        const tr = document.createElement('tr');
        tr.className = 'row';
        tr.dataset.id = t.id;

        const tdPos = document.createElement('td');
        tdPos.textContent = t.position ?? '';
        tdPos.className = 'small';
        tr.appendChild(tdPos);

        const tdName = document.createElement('td');
        tdName.innerHTML = `<div class="name">${escapeHtml(t.name || '')}</div>
                            <div class="mono">ID: ${escapeHtml(t.id || '')}</div>`;
        tr.appendChild(tdName);

        const tdComplaint = document.createElement('td');
        tdComplaint.textContent = t.complaint || '';
        tr.appendChild(tdComplaint);

        const tdCreated = document.createElement('td');
        tdCreated.textContent = fmtDate(t.createdAt);
        tr.appendChild(tdCreated);

        const tdStatus = document.createElement('td');
        const status = (t.status || 'waiting').toLowerCase();
        const badgeClass = status === 'called' ? 'called' : 'waiting';
        const label = status === 'called' ? 'Called' : 'Waiting';
        tdStatus.innerHTML = `<span class="badge ${badgeClass}">${label}</span>`;
        tr.appendChild(tdStatus);

        const tdActions = document.createElement('td');
        tdActions.className = 'actions';

        const btnNotify = document.createElement('button');
        const already = !!t.notifiedAt || status === 'called';
        btnNotify.className = 'btn ' + (already ? 'notified' : 'notify');
        btnNotify.textContent = already ? 'Notified' : 'Notify';
        btnNotify.disabled = already;
        btnNotify.addEventListener('click', (e)=>{ e.stopPropagation(); notify(t.id, btnNotify); });

        const btnDelete = document.createElement('button');
        btnDelete.className = 'btn delete';
        btnDelete.style.marginLeft = '10px';
        btnDelete.textContent = 'Delete';
        btnDelete.addEventListener('click', (e)=>{ e.stopPropagation(); remove(t.id); });

        tdActions.appendChild(btnNotify);
        tdActions.appendChild(btnDelete);
        tr.appendChild(tdActions);

        tr.addEventListener('click', ()=>{
          if(tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('details')){
            tr.nextSibling.remove();
            expanded.delete(t.id); setExpanded(expanded);
          }else{
            const dtr = document.createElement('tr');
            dtr.className = 'details';
            const dtd = document.createElement('td');
            dtd.colSpan = 6;
            dtd.style.background = '#fafafa';
            dtd.style.borderBottom = '1px solid var(--line)';
            dtd.style.padding = '14px 16px';
            dtd.innerHTML = `
              <div class="small"><strong>SSN:</strong> ${escapeHtml(t.kt || '')} &nbsp;&nbsp;
              <strong>Phone:</strong> ${escapeHtml(t.phone || '')}</div>
              <div class="small" style="margin-top:6px"><strong>Notes:</strong> ${escapeHtml(t.notes || '')}</div>`;
            dtr.appendChild(dtd);
            tr.after(dtr);
            expanded.add(t.id); setExpanded(expanded);
          }
        });

        $tbody.appendChild(tr);

        if(expanded.has(t.id)){
          tr.click();
        }
      }
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    async function load(){
      try{
        const res = await fetch(api('tickets-list'), {cache:'no-store'});
        const data = await res.json();
        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
        render(items);
      }catch(err){
        $tbody.innerHTML = '<tr><td colspan="6" class="small" style="padding:20px;color:#b91c1c">Failed to load queue.</td></tr>';
      }
    }

    load();
    setInterval(load, 10000);
  </script>
</body>
</html>
