<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinic queue</title>
  <link rel="stylesheet" href="/assets/app.css">
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <h1>Queue</h1>
          <p class="muted">Live list of active tickets. Auto-refresh every 10s.</p>
        </div>
        <div class="row">
          <a class="link small" href="/patient/">Patient form</a>
          <button class="secondary" id="refresh">Refresh</button>
        </div>
      </div>

      <table class="table" id="table">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Phone</th><th>Complaint</th><th>Created</th><th>Status</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="center small" style="display:none">No tickets yet.</div>
    </div>
  </div>

<script>
const api = (p) => fetch('/.netlify/functions/' + p);
const tbody = document.querySelector('#tbody');
const empty = document.querySelector('#empty');

async function load(){
  try{
    const res = await api('tickets-list');
    const out = await res.json();
    tbody.innerHTML = '';
    const items = (out && out.items) || [];
    if(items.length === 0){
      empty.style.display = 'block'; return;
    } else empty.style.display = 'none';

    for(const t of items){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="small">${t.id||t.key?.replace('tickets/','').replace('.json','')}</td>
        <td>${t.name||''}</td>
        <td>${t.phone||''}</td>
        <td>${t.complaint||''}</td>
        <td class="small">${t.createdAt ? new Date(t.createdAt).toLocaleString() : ''}</td>
        <td class="status ${t.status||'waiting'}">${t.status||'waiting'}</td>`;
      tbody.appendChild(tr);
    }
  }catch(e){
    // ignore
  }
}
document.querySelector('#refresh').addEventListener('click', load);
load();
setInterval(load, 10000);
</script>
</body>
</html>