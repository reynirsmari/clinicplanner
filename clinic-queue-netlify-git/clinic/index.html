<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinic Queue</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --green:#16a34a;
      --blue:#2563eb;
      --red:#dc2626;
      --pill:#eef2ff;
    }
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--text);}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px;}
    h1{font-size:28px;margin:0 0 16px 0;font-weight:700;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;box-shadow:0 4px 10px rgba(15,23,42,.04)}
    table{width:100%;border-collapse:collapse;}
    thead th{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);text-align:left;background:linear-gradient(#fafafa,#fff);border-bottom:1px solid var(--line);padding:14px 16px;}
    tbody td{padding:16px;border-bottom:1px solid var(--line);vertical-align:top;}
    tbody tr:last-child td{border-bottom:0}
    .idx{width:52px;color:var(--muted);font-weight:600}
    .name{font-weight:600;}
    .muted{color:var(--muted);font-size:12px}
    .status{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:600;font-size:12px}
    .status.called{color:var(--green);border-color:#bbf7d0;background:#ecfdf5}
    .status.waiting{color:#92400e;border-color:#fde68a;background:#fffbeb}
    .status.notified{color:#1d4ed8;border-color:#bfdbfe;background:#eff6ff}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:default}
    .btn.blue{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.red{background:#fff;color:var(--red);border-color:#fecaca}
    .row{cursor:default}
    .actions{white-space:nowrap;display:flex;gap:10px;align-items:center}
    .pill{display:inline-block;background:var(--pill);padding:4px 10px;border-radius:999px;font-size:12px;color:#3730a3;border:1px solid #e0e7ff}
    /* keep divider continuous under actions */
    td.actions-cell{position:relative;}
    td.actions-cell::after{
      content:"";position:absolute;left:0;right:0;bottom:-1px;height:1px;background:var(--line);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Queue</h1>
    <div class="card">
      <table id="queue">
        <thead>
          <tr>
            <th class="idx">#</th>
            <th>Name</th>
            <th>Primary complaint</th>
            <th>Created</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted" style="padding:24px">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    const fmt = (iso)=>{
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'}) + ", " +
               d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
      }catch{ return iso; }
    };

    async function fetchList(){
      const r = await fetch('/api/tickets-list');
      const j = await r.json();
      if(!j.ok){ throw new Error(j.error||'failed'); }
      return j.items || [];
    }

    function statusPill(s){
      const span = document.createElement('span');
      span.className = 'status ' + s;
      span.textContent = s.charAt(0).toUpperCase() + s.slice(1);
      return span;
    }

    async function notify(id, btn){
      btn.disabled = true;
      const r = await fetch('/api/tickets-notify?id='+encodeURIComponent(id), {method:'POST'});
      const j = await r.json().catch(()=>({ok:false}));
      if(j && j.ok){
        btn.textContent = 'Notified';
        btn.classList.remove('blue');
        btn.disabled = true;
      }else{
        alert('Failed to notify: ' + JSON.stringify(j||{}));
        btn.disabled = false;
      }
    }

    async function del(id){
      if(!confirm('Delete this ticket?')) return;
      const r = await fetch('/api/tickets-delete?id='+encodeURIComponent(id), {method:'POST'});
      const j = await r.json().catch(()=>({ok:false}));
      if(j && j.ok){
        render(); // refresh
      }else{
        alert('Failed to delete: ' + JSON.stringify(j||{}));
      }
    }

    async function render(){
      const tb = document.getElementById('tbody');
      tb.innerHTML = '<tr><td colspan="6" class="muted" style="padding:24px">Loading…</td></tr>';
      let items = await fetchList();
      // sort by position asc if present else createdAt
      items.sort((a,b)=> (a.position??999)-(b.position??999) || new Date(a.createdAt)-new Date(b.createdAt));
      tb.innerHTML = '';
      if(items.length===0){
        tb.innerHTML = '<tr><td colspan="6" class="muted" style="padding:24px">No patients in queue.</td></tr>';
        return;
      }
      items.forEach((t,idx)=>{
        const tr = document.createElement('tr');
        tr.className='row';
        tr.innerHTML = `
          <td class="idx">${(t.position??(idx+1))}</td>
          <td class="name">
            ${escapeHtml(t.name||'—')}
            <div class="muted">ID: ${escapeHtml(t.id||'')}</div>
          </td>
          <td>${escapeHtml(t.complaint||'—')}</td>
          <td>${fmt(t.createdAt)}</td>
          <td></td>
          <td class="actions-cell"><div class="actions"></div></td>
        `;
        // status
        tr.children[4].appendChild(statusPill(t.status||'waiting'));
        // actions
        const actionsDiv = tr.querySelector('.actions');
        const notifyBtn = document.createElement('button');
        notifyBtn.className='btn blue';
        notifyBtn.textContent = (t.status==='notified' || t.status==='called') ? 'Notified' : 'Notify';
        notifyBtn.disabled = (t.status==='notified' || t.status==='called');
        notifyBtn.onclick = ()=>notify(t.id, notifyBtn);
        const delBtn = document.createElement('button');
        delBtn.className='btn red';
        delBtn.textContent='Delete';
        delBtn.onclick = ()=>del(t.id);
        actionsDiv.appendChild(notifyBtn);
        actionsDiv.appendChild(delBtn);
        tb.appendChild(tr);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;","'":"&#39;"}[c]));
    }

    render();
    // keep previous behavior of auto-refresh without collapsing extras
    setInterval(render, 10000);
  </script>
</body>
</html>