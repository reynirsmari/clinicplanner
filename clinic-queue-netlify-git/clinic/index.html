<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinic Queue</title>
  <style>
    :root{ --bg:#f7f8fb; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb; --blue:#2563eb; --red:#dc2626; --green:#16a34a; }
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--text);}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px;}
    h1{font-size:28px;margin:0 0 16px 0;font-weight:700;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;box-shadow:0 4px 10px rgba(15,23,42,.04)}
    table{width:100%;border-collapse:collapse;}
    thead th{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);text-align:left;background:#fff;border-bottom:1px solid var(--line);padding:14px 16px;}
    tbody td{padding:16px;border-bottom:1px solid var(--line);vertical-align:top;}
    tbody tr:last-child td{border-bottom:0}
    .idx{width:52px;color:var(--muted);font-weight:600}
    .name{font-weight:600;}
    .muted{color:var(--muted);font-size:12px}
    .status{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:600;font-size:12px}
    .status.called{color:var(--green);border-color:#bbf7d0;background:#ecfdf5}
    .status.waiting{color:#92400e;border-color:#fde68a;background:#fffbeb}
    .status.notified{color:#1d4ed8;border-color:#bfdbfe;background:#eff6ff}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:default}
    .btn.blue{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.red{background:#fff;color:var(--red);border-color:#fecaca}
    .actions{white-space:nowrap;display:flex;gap:10px;align-items:center}
    td.actions-cell{position:relative;}
    td.actions-cell::after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:1px;background:var(--line);}
    tr.in-progress{opacity:.55;transition:opacity .15s ease;}
    /* Drag & drop */
    tr.row[draggable="true"]{}
    tr.row.dragging{opacity:.35; background:#f1f5f9}
    tr.row.drop-target{outline:2px dashed #cbd5e1; outline-offset:-6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Queue</h1>
    <div class="card">
      <table id="queue">
        <thead>
          <tr>
            <th class="idx">#</th>
            <th>Patient</th>  <!-- restored header label -->
            <th>Primary complaint</th>
            <th>Created</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted" style="padding:24px">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    const TBody = document.getElementById('tbody');
    const treatingKey = 'clinic:treating';
    const channelName = 'clinic-queue-sync';
    let firstLoad = true;

    function getTreating(){ try{return new Set(JSON.parse(localStorage.getItem(treatingKey)||'[]'));}catch{return new Set();} }
    function setTreating(set){ localStorage.setItem(treatingKey, JSON.stringify([...set])); }
    let treating = getTreating();

    function fmtDate(iso){
      try{ const d=new Date(iso);
        return d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'})+', '+
               d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
      }catch{return iso||'';}
    }

    async function fetchList(){
      const r = await fetch('/api/tickets-list', {cache:'no-store'});
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'Failed to load');
      return j.items || [];
    }

    function statusPill(s){
      const span = document.createElement('span');
      span.className = 'status ' + (s||'waiting');
      span.textContent = (s||'waiting').replace(/^./,c=>c.toUpperCase());
      return span;
    }

    async function actionNotify(id, btn){
      btn.disabled = true;
      const r = await fetch('/api/tickets-notify?id='+encodeURIComponent(id), {method:'POST'});
      const j = await r.json().catch(()=>({ok:false}));
      if(!j.ok){ alert('Failed to notify'); btn.disabled=false; return; }
      btn.textContent='Notified'; btn.classList.remove('blue'); btn.disabled=true;
    }

    async function actionDelete(id){
      if(!confirm('Delete this ticket?')) return;
      const r = await fetch('/api/tickets-delete?id='+encodeURIComponent(id), {method:'POST'});
      const j = await r.json().catch(()=>({ok:false}));
      if(!j.ok){ alert('Failed to delete'); return; }
      render(false);
    }

    function openTreat(id){
      treating.add(id); setTreating(treating);
      try{ new BroadcastChannel(channelName).postMessage({type:'treating-updated', id}); }catch{}
      window.open('/clinic/treat.html?id='+encodeURIComponent(id), '_blank');
      document.querySelectorAll(`tr[data-id="${id}"]`).forEach(tr=>tr.classList.add('in-progress'));
    }

    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function rowHtml(item, idx){
      const position = (item.position ?? (idx+1));
      const notified = !!item.notifiedAt || item.status === 'called';
      return `
        <tr class="row ${treating.has(item.id)?'in-progress':''}" data-id="${item.id}" draggable="true">
          <td class="idx">${position||''}</td>
          <td class="name">
            ${escapeHtml(item.name||'—')}
            <div class="muted">ID: ${escapeHtml(item.id||'')}</div>
          </td>
          <td>${escapeHtml(item.complaint||'—')}</td>
          <td>${fmtDate(item.createdAt)}</td>
          <td>${statusPill(item.status||'waiting').outerHTML}</td>
          <td class="actions-cell">
            <div class="actions">
              <button class="btn" onclick="openTreat('${item.id}')">Treat patient</button>
              <button class="btn blue" onclick="actionNotify('${item.id}', this)" ${notified?'disabled':''}>${notified?'Notified':'Notify'}</button>
              <button class="btn red" onclick="actionDelete('${item.id}')">Delete</button>
            </div>
          </td>
        </tr>`;
    }

    async function render(showLoading = firstLoad){
      try{
        const items = await fetchList();
        items.sort((a,b)=> (a.position??999)-(b.position??999) || new Date(a.createdAt)-new Date(b.createdAt));
        TBody.innerHTML = items.length ? items.map(rowHtml).join('') :
          '<tr><td colspan="6" class="muted" style="padding:24px">No patients in queue.</td></tr>';
        attachDnd();
      }catch(e){
        if(firstLoad) {
          TBody.innerHTML = '<tr><td colspan="6" class="muted" style="padding:24px;color:#b91c1c">Failed to load queue.</td></tr>';
        }
      }finally{
        firstLoad = false;
      }
    }

    function attachDnd(){
      let dragEl = null;
      let overEl = null;

      TBody.querySelectorAll('tr.row').forEach(tr=>{
        tr.addEventListener('dragstart', (e)=>{
          dragEl = tr;
          tr.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          try { e.dataTransfer.setData('text/plain', tr.dataset.id); } catch {}
        });
        tr.addEventListener('dragend', ()=>{
          if(dragEl) dragEl.classList.remove('dragging');
          if(overEl) overEl.classList.remove('drop-target');
          dragEl = null; overEl = null;
          renumber();
          saveOrder();
        });
      });

      TBody.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const target = e.target.closest('tr.row');
        if(!target || target === dragEl) return;
        overEl && overEl.classList.remove('drop-target');
        overEl = target;
        overEl.classList.add('drop-target');

        const rect = target.getBoundingClientRect();
        const before = (e.clientY - rect.top) < rect.height / 2;
        if(before){
          TBody.insertBefore(dragEl, target);
        }else{
          TBody.insertBefore(dragEl, target.nextSibling);
        }
      });

      TBody.addEventListener('drop', (e)=>{ e.preventDefault(); });
    }

    function renumber(){
      let i=1;
      TBody.querySelectorAll('tr.row').forEach(tr=>{
        const td = tr.querySelector('td.idx');
        if(td) td.textContent = i++;
      });
    }

    async function saveOrder(){
      const ids = [...TBody.querySelectorAll('tr.row')].map(tr=>tr.dataset.id);
      try{
        const r = await fetch('/api/tickets-reorder', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ order: ids })
        });
        const j = await r.json();
        if(!j.ok){ throw new Error(j.error || 'Save failed'); }
      }catch(e){
        alert('Failed to save order: ' + e.message);
      }
    }

    window.addEventListener('storage', (e)=>{
      if(e.key === treatingKey){
        treating = getTreating();
        document.querySelectorAll('tr[data-id]').forEach(tr=>{
          const id = tr.dataset.id;
          tr.classList.toggle('in-progress', treating.has(id));
        });
      }
    });
    try{
      const bc = new BroadcastChannel(channelName);
      bc.onmessage = (ev)=>{
        if(ev?.data?.type === 'treating-updated'){
          treating = getTreating();
          document.querySelectorAll('tr[data-id]').forEach(tr=>{
            const id = tr.dataset.id;
            tr.classList.toggle('in-progress', treating.has(id));
          });
        }
      };
    }catch{}

    render(true);
    setInterval(()=>render(false), 10000);
  </script>
</body>
</html>
