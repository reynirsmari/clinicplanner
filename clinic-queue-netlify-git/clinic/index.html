
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinic queue</title>
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0c10;color:#e5e7eb;margin:0}
    .wrap{max-width:1000px;margin:32px auto;padding:20px;border:1px solid rgba(255,255,255,.08);border-radius:16px;background:#101219}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{color:#a1a1aa;text-align:left}
    details{background:#0f1117;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:8px 12px}
    details[open]{outline:1px solid rgba(255,255,255,.12)}
    .actions button{margin-right:8px;border:0;border-radius:10px;padding:8px 12px;font-weight:600}
    .notify{background:#14532d;color:#c7f9d4}
    .delete{background:#3f1d2b;color:#ffd6e0}
    .light{color:#cbd5e1}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Queue</h1>
    <table id="tbl">
      <thead>
        <tr>
          <th>Patient</th>
          <th>Primary complaint</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </main>

  <script type="module">
    const rows = document.getElementById("rows");
    const OPEN_KEY = "clinic_open_ids";

    function loadOpenSet(){
      try {
        return new Set(JSON.parse(localStorage.getItem(OPEN_KEY) || "[]"));
      } catch { return new Set(); }
    }
    function saveOpenSet(s){
      localStorage.setItem(OPEN_KEY, JSON.stringify([...s]));
    }

    function tr(item, openSet){
      const t = item.value || item;
      const id = t.id;
      const open = openSet.has(id);
      const created = new Date(t.createdAt).toLocaleString();

      const el = document.createElement("tr");
      el.innerHTML = `
        <td style="width:33%">
          <details data-id="${id}" ${open ? "open" : ""}>
            <summary><strong>${t.name}</strong> <span class="light">(#${id})</span></summary>
            <div class="light" style="margin-top:8px">
              <div><strong>KT:</strong> ${t.kt}</div>
              <div><strong>Phone:</strong> ${t.phone}</div>
              <div><strong>Notes:</strong> ${t.notes || "—"}</div>
              <div><strong>Status:</strong> ${t.status || "waiting"}</div>
            </div>
          </details>
        </td>
        <td>${t.complaint || "—"}</td>
        <td>${created}</td>
        <td class="actions">
          <button class="notify" data-act="notify" data-id="${id}">Notify</button>
          <button class="delete" data-act="delete" data-id="${id}">Delete</button>
        </td>`;
      return el;
    }

    rows.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-act]");
      if(!btn) return;
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      if(act === "notify"){
        const res = await fetch(`/api/tickets-notify?id=${encodeURIComponent(id)}`, { method:"POST" });
        const data = await res.json().catch(()=>({ok:false}));
        if(!data.ok) alert("Failed to notify: " + JSON.stringify(data));
      } else if (act === "delete"){
        if(!confirm("Remove this patient from the queue?")) return;
        const res = await fetch(`/api/tickets-delete?id=${encodeURIComponent(id)}`, { method:"DELETE" });
        const data = await res.json().catch(()=>({ok:false}));
        if(!data.ok) alert("Failed to delete: " + JSON.stringify(data));
      }
      await refresh(); // reflect immediately
    });

    rows.addEventListener("toggle", (e)=>{
      if(e.target.tagName !== "DETAILS") return;
      const id = e.target.dataset.id;
      const set = loadOpenSet();
      if(e.target.open) set.add(id); else set.delete(id);
      saveOpenSet(set);
    }, true);

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function refresh(){
      const openSet = loadOpenSet();
      const data = await fetchJSON("/api/tickets-list");
      rows.innerHTML = "";
      (data.items || []).forEach(item => rows.appendChild(tr(item, openSet)));
    }

    await refresh();
    setInterval(refresh, 4000);
  </script>
</body>
</html>
