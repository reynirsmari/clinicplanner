
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Patient check‑in</title>
  <link rel="stylesheet" href="/assets/app.css"/>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <h1>Check‑in</h1>
          <p class="lead">Please fill in your details. We’ll add you to today’s queue.</p>
        </div>
        <a class="badge" href="/clinic/">For staff →</a>
      </div>

      <form id="f" class="row">
        <div>
          <div class="label">Full name *</div>
          <input class="input" name="name" required autocomplete="name" />
        </div>

        <div>
          <div class="label">Kennitala (ID)</div>
          <input class="input" name="kt" inputmode="numeric" maxlength="10" minlength="10" placeholder="10 digits"/>
        </div>

        <div>
          <div class="label">Phone *</div>
          <input class="input" name="phone" required inputmode="numeric" maxlength="7" placeholder="7 digits"/>
        </div>

        <div>
          <div class="label">Primary complaint *</div>
          <select name="complaint" class="input" required>
            <option value="" disabled selected>Select…</option>
            <option>Respiratory</option>
            <option>Fever</option>
            <option>Stomach</option>
            <option>Injury</option>
            <option>Other</option>
          </select>
        </div>

        <div style="grid-column:1/-1">
          <div class="label">Notes (optional)</div>
          <textarea class="input" name="notes" placeholder="Anything we should know in advance?"></textarea>
        </div>

        <div style="grid-column:1/-1; display:flex; gap:12px; align-items:center; justify-content:flex-end; margin-top:6px">
          <button class="btn" type="submit">Get my ticket</button>
        </div>
      </form>

      <p class="footer-note">By checking in you agree to our privacy policy.</p>
    </div>
  </div>

<script>
const F = document.getElementById('f');
const CREATE_URL = '/.netlify/functions/tickets-create';

F.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(F);
  const payload = Object.fromEntries(fd.entries());
  if(payload.phone){ payload.phone = payload.phone.replace(/\D+/g,'').slice(-7); }
  try{
    const res = await fetch(CREATE_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if(data && data.id){ sessionStorage.setItem('lastTicketId', data.id); }
    if(!res.ok || !data || !data.id){
      alert('Sorry, we could not create your ticket. Please try again.');
      console.warn('Create response', data);
      return;
    }
    location.href = `/patient/ticket.html?id=${encodeURIComponent(data.id)}`;
  }catch(err){
    console.error(err);
    alert('Network error. Please try again.');
  }
});
</script>
</body>
</html>
