<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check‑In</title>
  <link rel="stylesheet" href="/assets/app.css">
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <h1>Clinic Check‑In</h1>
          <p class="muted">Please fill out your details. Fields marked * are required.</p>
        </div>
        <a class="link small" href="/clinic/">Clinic queue →</a>
      </div>

      <form id="form" class="grid cols-2">
        <div>
          <label>Full name *</label>
          <input name="name" required autocomplete="name" />
        </div>
        <div>
          <label>National ID / SSN *</label>
          <input name="kt" required inputmode="numeric" />
        </div>
        <div>
          <label>Phone *</label>
          <input name="phone" required inputmode="tel" autocomplete="tel" />
        </div>
        <div>
          <label>Main complaint *</label>
          <select name="complaint" required>
            <option value="">Select…</option>
            <option>Respiratory</option>
            <option>Abdominal pain</option>
            <option>Headache</option>
            <option>Musculoskeletal</option>
            <option>Fever</option>
            <option>Other</option>
          </select>
        </div>
        <div class="cols-2" style="grid-column:1/-1">
          <div class="row checkbox">
            <input id="rf1" type="checkbox" value="Severe bleeding">
            <label for="rf1">Severe bleeding</label>
          </div>
          <div class="row checkbox">
            <input id="rf2" type="checkbox" value="Chest pain">
            <label for="rf2">Chest pain</label>
          </div>
          <div class="row checkbox">
            <input id="rf3" type="checkbox" value="Shortness of breath at rest">
            <label for="rf3">Shortness of breath at rest</label>
          </div>
        </div>
        <div style="grid-column:1/-1">
          <label>Anything the doctor should know?</label>
          <textarea name="notes" placeholder="Optional"></textarea>
        </div>
        <div class="row" style="grid-column:1/-1;justify-content:flex-end;gap:10px">
          <button type="submit" id="btn">Get my ticket</button>
        </div>
      </form>
      <p id="msg" class="small" style="margin-top:10px"></p>
    </div>
  </div>

<script>
const api = (p, init) => fetch('/.netlify/functions/' + p, init);

const $ = s => document.querySelector(s);
const form = $('#form');
const btn  = $('#btn');
const msg  = $('#msg');

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  btn.disabled = true; msg.textContent = 'Creating your ticket…';
  try {
    const data = {
      name: form.name.value.trim(),
      kt: form.kt.value.trim(),
      phone: form.phone.value.trim(),
      complaint: form.complaint.value,
      notes: form.notes.value.trim(),
      redFlags: Array.from([$('#rf1'),$('#rf2'),$('#rf3')]).filter(i=>i.checked).map(i=>i.value)
    };
    const res = await api('tickets-create', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const out = await res.json().catch(()=>({ok:false}));
    if(out.ok && out.id){
      location.href = `/patient/ticket.html?id=${encodeURIComponent(out.id)}`;
    }else{
      throw new Error(out.error||'Failed to create ticket');
    }
  } catch(err){
    msg.textContent = 'Sorry, we could not create your ticket. Please try again.';
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>