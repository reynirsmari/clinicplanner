<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinic Check-In</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --ink:#0f172a; --muted:#64748b; --accent:#0ea5e9;
      --ok:#0ea5e9; --danger:#ef4444; --ring:#93c5fd;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink); background:var(--bg);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{max-width:860px; width:100%}
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:0 10px 40px rgba(2,6,23,.08);
      padding:24px 20px; border:1px solid #e5e7eb;
    }
    h1{margin:0 0 12px; font-weight:800; letter-spacing:.2px}
    p.sub{margin:.25rem 0 1rem; color:var(--muted)}
    .grid{display:grid; gap:14px}
    @media(min-width:720px){ .grid{grid-template-columns: 1fr 1fr} .span2{grid-column:1/-1} }

    label.l{font-weight:600; font-size:14px; margin-bottom:6px; display:block}
    .input, select, textarea{
      width:100%; padding:14px 14px; border-radius:12px; border:1px solid #e5e7eb; background:#f9fafb;
      outline:none;
    }
    .input:focus, select:focus, textarea:focus{border-color:var(--ring); box-shadow:0 0 0 3px rgba(147,197,253,.45)}
    textarea{min-height:110px; resize:vertical}

    .radio-row, .flag-grid{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .flag{border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#fff; display:flex; gap:10px; align-items:center}
    .consent{display:flex; gap:10px; align-items:flex-start; background:#f8fafc; padding:12px 12px; border-radius:12px; border:1px solid #e5e7eb}

    .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:8px}
    button{
      appearance:none; border:0; background:var(--ok); color:#fff; font-weight:700; padding:14px 18px;
      border-radius:14px; cursor:pointer; transition:.15s transform ease;
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .pill{font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3}
    .note{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <h1>Clinic Check-In</h1>
      <p class="sub">Fill this in to join the queue. Fields marked * are required.</p>

      <form id="checkinForm" class="grid" novalidate>
        <div>
          <label class="l" for="kt">Kennitala / ID *</label>
          <input class="input" id="kt" name="kt" inputmode="numeric" autocomplete="off" placeholder="10 digits" required />
        </div>

        <div>
          <label class="l" for="name">Full name *</label>
          <input class="input" id="name" name="name" autocomplete="name" placeholder="Your name" required />
        </div>

        <div>
          <label class="l" for="phone">Mobile phone *</label>
          <input class="input" id="phone" name="phone" inputmode="tel" autocomplete="tel" placeholder="e.g. 660 5725" required />
        </div>

        <div>
          <label class="l">Is this an acute emergency? *</label>
          <div class="radio-row">
            <label><input type="radio" name="acute" value="Yes" required /> Yes</label>
            <label><input type="radio" name="acute" value="No" required /> No</label>
            <span class="pill">ABC: trouble breathing, chest pain, severe bleeding, fainting → Yes</span>
          </div>
        </div>

        <div class="span2">
          <label class="l" for="complaint">Main complaint</label>
          <select id="complaint" name="complaint">
            <option value="">Select…</option>
            <option>Respiratory</option>
            <option>Gastrointestinal</option>
            <option>Musculoskeletal</option>
            <option>Dermatological</option>
            <option>Cardiac</option>
            <option>Neurological</option>
            <option>Urological</option>
            <option>Other</option>
          </select>
        </div>

        <div class="span2">
          <label class="l">Red flags (select any)</label>
          <div class="flag-grid">
            <label class="flag"><input type="checkbox" name="redFlags[]" value="Shortness of breath at rest" /> Shortness of breath at rest</label>
            <label class="flag"><input type="checkbox" name="redFlags[]" value="Chest pain" /> Chest pain</label>
            <label class="flag"><input type="checkbox" name="redFlags[]" value="Severe bleeding" /> Severe bleeding</label>
            <label class="flag"><input type="checkbox" name="redFlags[]" value="Fainting" /> Fainting</label>
            <label class="flag"><input type="checkbox" name="redFlags[]" value="High fever infant <3 months" /> High fever infant &lt;3 months</label>
          </div>
        </div>

        <div class="span2">
          <label class="l" for="notes">Anything else the doctor should know?</label>
          <textarea id="notes" name="notes" placeholder="Optional…"></textarea>
        </div>

        <div class="span2 consent">
          <input id="consent" type="checkbox" required />
          <label for="consent">
            I consent to processing my data for triage and queueing. <span class="note">Required to continue.</span>
          </label>
        </div>

        <div class="span2 actions">
          <button id="submitBtn" type="submit" disabled>Get my ticket</button>
        </div>

        <div class="span2 note">
          This page will redirect you to your ticket after submission.
        </div>
      </form>
    </div>
  </main>

  <script>
    (function () {
      const form = document.getElementById('checkinForm');
      const btn  = document.getElementById('submitBtn');
      const consent = document.getElementById('consent');

      // enable button only when consent + required fields are present
      const requiredIds = ['kt','name','phone'];
      const requiredEls = requiredIds.map(id => document.getElementById(id));
      const radios = Array.from(document.querySelectorAll('input[name="acute"]'));

      function updateButton() {
        const haveBasics = requiredEls.every(el => el.value.trim().length > 0);
        const acutePicked = radios.some(r => r.checked);
        btn.disabled = !(consent.checked && haveBasics && acutePicked);
      }
      [...requiredEls, consent, ...radios].forEach(el =>
        el.addEventListener('input', updateButton)
      );
      updateButton();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        btn.disabled = true;

        const fd = new FormData(form);

        const payload = {
          kt:   fd.get('kt')?.trim() || '',
          name: fd.get('name')?.trim() || '',
          phone: fd.get('phone')?.trim() || '',
          acute: (fd.get('acute') === 'Yes' || fd.get('acute') === 'true'),
          complaint: fd.get('complaint') || '',
          notes: fd.get('notes') || '',
          redFlags: Array.from(
            document.querySelectorAll('input[name="redFlags[]"]:checked')
          ).map(i => i.value)
        };

        try {
          const res = await fetch('/api/tickets-create', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await res.json().catch(() => ({}));

          // accept { id } OR derive from { key: "tickets/xyz.json" }
          let id = data?.id;
          if (!id && data?.key) {
            id = String(data.key).split('/').pop().replace('.json','');
          }

          if (!res.ok || !id) {
            console.warn('Create response:', data);
            alert('Sorry, we could not create your ticket. Please try again.');
            btn.disabled = false;
            return;
          }

          window.location.href = `/patient/ticket.html?id=${encodeURIComponent(id)}`;
        } catch (err) {
          console.error(err);
          alert('Network error while creating ticket.');
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
