
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Your ticket</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main class="container">
    <div class="panel">
      <h1>Your ticket</h1>
      <p>Keep this page open. Weâ€™ll update your status automatically.</p>
      <div id="status" class="kv"></div>
      <div id="advice" class="notice" style="display:none"></div>
    </div>
  </main>
  <script>
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  const statusEl = document.getElementById('status');
  const advice = document.getElementById('advice');

  async function refresh(){
    if (!id) {
      statusEl.innerHTML = '<div><span>Ticket:</span> not found</div>';
      return;
    }
    const res = await fetch('/api/tickets-get?id='+encodeURIComponent(id));
    const data = await res.json().catch(()=>({}));
    if (!data.ok || !data.item) {
      statusEl.innerHTML = '<div><span>Ticket:</span> not found</div>';
      return;
    }
    const t = data.item;
    statusEl.innerHTML = `
      <div><span>Ticket ID:</span> ${t.id}</div>
      <div><span>Name:</span> ${t.name}</div>
      <div><span>Primary complaint:</span> ${t.complaint}</div>
      <div><span>Status:</span> ${t.notified ? 'Being called' : 'Waiting'}</div>
      <div><span>Your position in line:</span> #${data.position}</div>
    `;
    if (data.position <= 4 && !t.notified) {
      advice.style.display = 'block';
      advice.textContent = 'Please make sure you are in the waiting area. You may be called soon.';
    } else {
      advice.style.display = 'none';
    }
  }
  refresh();
  setInterval(refresh, 5000);
  </script>
</body>
</html>
