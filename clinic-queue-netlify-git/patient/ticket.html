
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Your ticket</title>
  <link rel="stylesheet" href="/assets/app.css"/>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <h1>Your ticket</h1>
          <p class="lead">Keep this page open. We’ll update your status automatically.</p>
        </div>
        <a class="badge" href="/patient/">Back to form</a>
      </div>

      <div id="statusArea" class="center">
        <div id="statusLine" style="font-size:28px; margin:40px 0 6px">Loading…</div>
        <div class="ticket-id mono" id="ticketId"></div>
        <div id="tips" class="dim" style="margin-top:18px"></div>
      </div>
    </div>
  </div>

<script>
const GET_URL = '/.netlify/functions/tickets-get';

function getTicketId(){
  const p = new URLSearchParams(location.search);
  return p.get('id') || sessionStorage.getItem('lastTicketId') || '';
}

let ticketId = getTicketId();
const idEl = document.getElementById('ticketId');
const statusEl = document.getElementById('statusLine');
const tipsEl = document.getElementById('tips');

if(!ticketId){
  statusEl.textContent = 'Ticket not found.';
} else {
  idEl.textContent = 'ID: ' + ticketId;
  poll();
  setInterval(poll, 5000);
}

async function poll(){
  try{
    const res = await fetch(`${GET_URL}?id=${encodeURIComponent(ticketId)}`, { headers:{'Accept':'application/json'} });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || !data || !data.ok){
      statusEl.textContent = 'Ticket not found.';
      tipsEl.textContent = '';
      return;
    }
    statusEl.textContent = humanStatus(data.ticket?.status || 'waiting');
    tipsEl.textContent = data.position != null ? `People ahead of you: ${data.position}` : '';
  }catch(e){
    console.warn(e);
    statusEl.textContent = 'Connection issue. Retrying…';
  }
}

function humanStatus(s){
  switch(String(s)){
    case 'waiting': return 'Waiting in queue';
    case 'called': return 'It’s your turn — please come in';
    case 'done': return 'Visit completed';
    default: return 'Waiting in queue';
  }
}
</script>
</body>
</html>
