<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Your ticket</title>
  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --green:#16a34a; --blue:#2563eb; --amber:#b45309;
    }
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:760px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:24px 24px 28px;box-shadow:0 4px 10px rgba(15,23,42,.05)}
    h1{font-size:28px;margin:0 0 10px 0}
    p.muted{color:var(--muted);margin:0 0 20px 0}
    .row{display:flex; gap:16px; flex-wrap:wrap; align-items:center}
    .bigNumber{
      font-size:48px;font-weight:800;line-height:1;
      padding:16px 24px;border-radius:14px;
      background:#eef2ff;border:1px solid #e0e7ff;color:#3730a3;
      min-width:120px;text-align:center
    }
    .statusBanner{
      margin-top:18px;padding:16px;border-radius:14px;border:1px solid #bbf7d0;background:#ecfdf5;
      color:var(--green);font-weight:800;font-size:18px;
    }
    .warnBanner{
      margin-top:18px;padding:16px;border-radius:14px;border:1px solid #fde68a;background:#fffbeb;color:var(--amber);font-weight:700
    }
    .mutedRow{color:var(--muted);font-size:14px;margin-top:10px}
    .err{color:#b91c1c;font-weight:700}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;margin-top:10px}
    .kv div:first-child{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Your ticket</h1>
      <p class="muted">Keep this page open. We'll update your status automatically.</p>

      <div class="row">
        <div>
          <div class="muted">Your number in line</div>
          <div id="position" class="bigNumber">—</div>
        </div>
        <div class="kv">
          <div>Ticket ID</div><div id="ticketId">—</div>
          <div>Name</div><div id="name">—</div>
          <div>Primary complaint</div><div id="complaint">—</div>
          <div>Status</div><div id="statusText">—</div>
        </div>
      </div>

      <div id="banner" style="display:none"></div>

      <div id="error" class="err" style="display:none;margin-top:12px">Ticket not found.</div>
    </div>
  </div>

  <script>
    function robustId(){
      const urlTry = new URL(location.href);
      const qsId = urlTry.searchParams.get('id');
      if(qsId) return qsId;

      // manual parse (in case URL APIs choke on odd encodings)
      if(location.search && location.search.indexOf('id=')>=0){
        const m = location.search.replace(/^\?/,'').split('&').map(s=>s.split('='));
        for(const [k,v] of m){ if(k==='id') return decodeURIComponent(v||''); }
      }
      // referrer
      try{
        const ref = document.referrer;
        if(ref){
          const q = new URL(ref).searchParams.get('id');
          if(q) return q;
        }
      }catch{}
      // storage
      try{
        const s = sessionStorage.getItem('lastTicketID') || localStorage.getItem('lastTicketID');
        if(s) return s;
      }catch{}
      return '';
    }

    function setBanner(type, html){
      const el = document.getElementById('banner');
      el.className = type==='green' ? 'statusBanner' : 'warnBanner';
      el.innerHTML = html;
      el.style.display = 'block';
    }

    async function load(){
      const id = robustId();
      if(id) { try{ sessionStorage.setItem('lastTicketID', id); }catch{} }
      document.getElementById('ticketId').textContent = id || '—';
      if(!id){
        document.getElementById('error').style.display='block';
        return;
      }

      const ticketRes = await fetch('/api/tickets-get?id='+encodeURIComponent(id));
      const ticketJson = await ticketRes.json().catch(()=>({ok:false}));
      if(!ticketJson.ok || !ticketJson.ticket){
        document.getElementById('error').style.display='block';
        return;
      }
      const t = ticketJson.ticket;
      document.getElementById('name').textContent = t.name || '—';
      document.getElementById('complaint').textContent = t.complaint || '—';
      document.getElementById('statusText').textContent = t.status || '—';

      // compute position from list
      try{
        const listRes = await fetch('/api/tickets-list');
        const list = await listRes.json();
        let pos = '—';
        if(list && list.ok && Array.isArray(list.items)){
          // items already contain position; find this id
          const found = list.items.find(x=>x.id===t.id);
          if(found && (found.position || found.position===0)) pos = found.position;
          else{
            // fallback compute position among waiting/notified/called order by createdAt
            const waiting = list.items
               .filter(x=>['waiting','notified','called'].includes(x.status))
               .sort((a,b)=> new Date(a.createdAt)-new Date(b.createdAt));
            const idx = waiting.findIndex(x=>x.id===t.id);
            if(idx>=0) pos = idx+1;
          }
        }
        document.getElementById('position').textContent = pos;
        // banners
        if(t.status==='called'){
          setBanner('green', '<strong>You have been called.</strong> Please proceed to the consultation room now.');
        }else if(t.status==='notified'){
          setBanner('green', '<strong>You are next.</strong> Please make sure you are in the waiting room.');
        }else if(pos!== '—' && Number(pos)<=4){
          setBanner('amber', '<strong>You are approaching your turn.</strong> Please make sure you are in the waiting room.');
        }
      }catch(e){}
    }

    load();
    setInterval(load, 10000);
  </script>
</body>
</html>