
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your ticket</title>
  <style>
    :root {
      --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --ok:#16a34a; --ok-2:#14532d; --warn:#dc2626;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;}
    .wrap{max-width:860px;margin:32px auto;padding:0 16px;}
    h1{font-size:22px;font-weight:700;margin:0 0 14px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 4px 16px rgba(15,23,42,.06);
      padding:20px;border:1px solid var(--line);}
    .muted{color:var(--muted);}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:600}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .banner{display:none;margin-top:14px;border:1px solid #bbf7d0;background:#dcfce7;color:#065f46;
      padding:12px 14px;border-radius:12px;font-weight:700}
    .error{display:none;margin-top:14px;border:1px solid #fecaca;background:#fee2e2;color:#7f1d1d;
      padding:12px 14px;border-radius:12px;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Your ticket</h1>
    <div class="card">
      <div class="row">
        <div><span class="muted">Ticket ID:</span> <span id="ticket-id" class="mono">—</span></div>
        <div><span class="muted">Name:</span> <span id="name">—</span></div>
        <div><span class="muted">Primary complaint:</span> <span id="complaint">—</span></div>
      </div>
      <div class="row">
        <div><span class="muted">Status:</span> <span id="status" class="badge">—</span></div>
        <div><span class="muted">Your position in queue:</span> <strong id="position">—</strong></div>
      </div>

      <div id="banner" class="banner"></div>
      <div id="error" class="error"></div>
    </div>
  </div>

  <script>
    function getIdRobust() {
      try {
        const u = new URL(location.href);
        let id = u.searchParams.get('id');
        if (!id) {
          // manual parse (guard against stray unicode or rewrites)
          const q = (location.href.split('?')[1] || '').split('#')[0];
          for (const part of q.split('&')) {
            const [k,v] = part.split('=');
            if ((k||'').trim().toLowerCase() === 'id') { id = decodeURIComponent(v||''); break; }
          }
        }
        if (!id) {
          // sometimes the referrer still has it
          try { id = new URL(document.referrer).searchParams.get('id') || id; } catch {}
        }
        if (!id) {
          id = sessionStorage.getItem('lastTicketID') || localStorage.getItem('lastTicketID') || '';
        }
        return (id || '').replace(/[^a-zA-Z0-9_-]/g, '');
      } catch { return ''; }
    }

    const els = {
      id: document.getElementById('ticket-id'),
      name: document.getElementById('name'),
      complaint: document.getElementById('complaint'),
      status: document.getElementById('status'),
      position: document.getElementById('position'),
      banner: document.getElementById('banner'),
      error: document.getElementById('error'),
    };

    async function fetchJSON(url, options) {
      const r = await fetch(url, options);
      const t = await r.text();
      try { return JSON.parse(t); } catch { return { ok:false, error:'Bad JSON', raw:t }; }
    }

    function setError(msg) {
      els.error.textContent = msg;
      els.error.style.display = '';
    }

    function updateBanner(item) {
      // prefer explicit status; fall back to presence of notifiedAt
      const status = item.status || (item.notifiedAt ? 'notified' : 'waiting');
      if (status === 'called') {
        els.banner.textContent = 'Please proceed to the consultation room now.';
        els.banner.style.display = '';
      } else if (status === 'notified') {
        els.banner.textContent = 'You are next. Please make sure you are in the waiting room.';
        els.banner.style.display = '';
      } else {
        els.banner.style.display = 'none';
      }
    }

    async function refresh() {
      const id = getIdRobust();
      if (!id) {
        setError('Missing ticket id in URL. If you just created a ticket, please open the link again from the confirmation.');
        return;
      }
      els.id.textContent = id;
      // Get ticket details
      const one = await fetchJSON('/api/tickets-get?id=' + encodeURIComponent(id));
      if (!one.ok) { setError('Ticket not found'); return; }

      const t = one.ticket || one;
      els.name.textContent = t.name || '—';
      els.complaint.textContent = t.complaint || '—';
      els.status.textContent = (t.status || 'waiting').replace(/^./, c=>c.toUpperCase());

      // Find position from the list
      const list = await fetchJSON('/api/tickets-list');
      if (list.ok && Array.isArray(list.items)) {
        const hit = list.items.find(i => i.id === id);
        if (hit) {
          els.position.textContent = (hit.position != null ? hit.position : '—');
          // update status from list if newer
          if (hit.status) els.status.textContent = hit.status.replace(/^./, c=>c.toUpperCase());
          updateBanner(hit);
        } else {
          els.position.textContent = '—';
          updateBanner(t);
        }
      } else {
        updateBanner(t);
      }
      sessionStorage.setItem('lastTicketID', id);
    }

    refresh();
    setInterval(refresh, 15000);
  </script>
</body>
</html>
