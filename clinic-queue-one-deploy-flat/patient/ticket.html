
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Your Ticket</title>
  <style>
    :root { --bg:#f8fafc; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; }
    *{ box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Helvetica,Arial }
    body{ margin:0; background:var(--bg); color:var(--ink) }
    .wrap{ max-width:760px; margin:0 auto; padding:16px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.05) }
    .grid{ display:grid; gap:12px } .kpi{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px }
    .tile{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center }
    .cap{ color:var(--muted); font-size:12px } .val{ font-size:22px; font-weight:700 }
    .pill{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:12px; padding:8px 10px }
  </style>
</head>
<body>
<div class="wrap">
  <h1 style="font-size:20px;margin:12px 0 16px">Your Ticket</h1>
  <div class="card">
    <div class="kpi">
      <div class="tile"><div class="cap">Ticket</div><div class="val" id="t_id">—</div></div>
      <div class="tile"><div class="cap">Priority</div><div class="val" id="t_band">—</div></div>
      <div class="tile"><div class="cap">Position</div><div class="val" id="t_pos">—</div></div>
      <div class="tile"><div class="cap">ETA</div><div class="val" id="t_eta">—</div></div>
    </div>
    <div style="display:flex; gap:8px; margin-top:8px">
      <button id="cancel" class="pill">Cancel visit</button>
    </div>
    <p class="muted">This page updates every 5 seconds. Keep it open.</p>
  </div>
</div>
<script>
  const API_BASE = '/.netlify/functions/';
  const api = (p,o)=> fetch(API_BASE+p,o);
  const id = new URLSearchParams(location.search).get('id');
  async function load(){
    if (!id){ document.body.innerHTML='<p style="padding:20px">Missing ticket id.</p>'; return; }
    try{
      const r = await api('tickets-get?id='+encodeURIComponent(id));
      if (!r.ok) return;
      const t = await r.json();
      document.getElementById('t_id').textContent = t.id;
      document.getElementById('t_band').textContent = t.band;
      document.getElementById('t_pos').textContent = t.position ?? 0;
      document.getElementById('t_eta').textContent = (t.estWait||0) + ' min';
      if (t.position===0) alert('You are next! Please proceed to reception.');
    }catch{}
  }
  async function poll(){ await load(); setTimeout(poll, 5000); } poll();
  document.getElementById('cancel').onclick = async ()=>{
    await api('tickets-action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,action:'cancel'})});
    location.href = './';
  };
</script>
</body>
</html>
